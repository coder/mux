name: Latest Desktop

on:
  push:
    branches: [main]

concurrency:
  group: latest-desktop-${{ github.ref }}
  cancel-in-progress: true

jobs:
  compute-version:
    name: Compute version and create pre-release
    runs-on: ubuntu-latest
    permissions:
      contents: write # Create and manage pre-releases
    outputs:
      release_tag: ${{ steps.compute.outputs.release_tag }}
      dev_version: ${{ steps.compute.outputs.dev_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0 # Required for git describe to find tags
          persist-credentials: false

      - name: Compute latest pre-release version
        id: compute
        shell: bash
        run: |
          TAG_BASE=$(git describe --tags --abbrev=0 --match 'v*')
          IFS='.' read -r MAJOR MINOR PATCH <<< "${TAG_BASE#v}"
          PATCH="${PATCH%%-*}"
          NEXT_PATCH="${MAJOR}.${MINOR}.$((PATCH + 1))"
          COMMITS=$(git rev-list --count HEAD "^$TAG_BASE")
          DEV_VERSION="${NEXT_PATCH}-dev.${COMMITS}"
          RELEASE_TAG="v${DEV_VERSION}"

          echo "release_tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"
          echo "dev_version=$DEV_VERSION" >> "$GITHUB_OUTPUT"

      - name: Create pre-release if missing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ steps.compute.outputs.release_tag }}
        run: |
          if ! gh release view "$RELEASE_TAG" &>/dev/null; then
            gh release create "$RELEASE_TAG" --prerelease --target "$GITHUB_SHA" --title "$RELEASE_TAG" --notes "Automated latest build from main ($(date -u +%Y-%m-%d))"
          fi

  desktop-builds:
    name: Build and Release Desktop Apps
    needs: compute-version
    uses: ./.github/workflows/_desktop-release.yml
    with:
      ref: ${{ github.sha }}
      release_tag: ${{ needs.compute-version.outputs.release_tag }}
      version_override: ${{ needs.compute-version.outputs.dev_version }}
    secrets: inherit # zizmor: ignore[secrets-inherit] -- reusable workflow needs platform signing secrets

  cleanup:
    name: Cleanup old latest pre-releases
    runs-on: ubuntu-latest
    needs: [compute-version, desktop-builds]
    if: always()
    permissions:
      contents: write # Delete old pre-releases
    steps:
      - name: Delete old v*-dev.* pre-releases beyond latest 20
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          mapfile -t OLD_TAGS < <(
            gh api --paginate "repos/${GITHUB_REPOSITORY}/releases?per_page=100" --jq '
              .[]
              | select(.prerelease)
              | select(.tag_name | test("^v[0-9]+\\.[0-9]+\\.[0-9]+-dev\\.[0-9]+$"))
              | [.created_at, .tag_name]
              | @tsv
            ' \
              | sort -r \
              | awk 'NR > 20 { print $2 }'
          )

          if [ "${#OLD_TAGS[@]}" -eq 0 ]; then
            echo "No old latest pre-releases to delete."
            exit 0
          fi

          for tag in "${OLD_TAGS[@]}"; do
            echo "Deleting old pre-release $tag"
            gh release delete "$tag" --yes --cleanup-tag
          done
