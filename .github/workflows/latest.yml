name: Latest Desktop

on:
  push:
    branches: [main]

concurrency:
  group: latest-desktop-${{ github.ref }}
  cancel-in-progress: true

jobs:
  compute-version:
    name: Compute version and create pre-release
    runs-on: ubuntu-latest
    permissions:
      contents: write # Create and manage pre-releases
    outputs:
      release_tag: ${{ steps.compute.outputs.release_tag }}
      dev_version: ${{ steps.compute.outputs.dev_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0 # Required for git describe to find tags
          persist-credentials: false

      - name: Compute latest pre-release version
        id: compute
        shell: bash
        run: |
          TAG_BASE=$(git describe --tags --abbrev=0 --match 'v*')
          IFS='.' read -r MAJOR MINOR PATCH <<< "${TAG_BASE#v}"
          PATCH="${PATCH%%-*}"
          NEXT_PATCH="${MAJOR}.${MINOR}.$((PATCH + 1))"
          COMMITS=$(git rev-list --count HEAD "^$TAG_BASE")
          DEV_VERSION="${NEXT_PATCH}-dev.${COMMITS}"
          RELEASE_TAG="v${DEV_VERSION}"

          echo "release_tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"
          echo "dev_version=$DEV_VERSION" >> "$GITHUB_OUTPUT"

      - name: Create pre-release if missing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ steps.compute.outputs.release_tag }}
        run: |
          if ! gh release view "$RELEASE_TAG" &>/dev/null; then
            gh release create "$RELEASE_TAG" --prerelease --target "$GITHUB_SHA" --title "$RELEASE_TAG" --notes "Automated latest build from main ($(date -u +%Y-%m-%d))"
          fi

  build-macos:
    name: Build and Release macOS
    needs: compute-version
    runs-on: ${{ github.repository_owner == 'coder' && 'depot-macos-15' || 'macos-latest' }}
    permissions:
      contents: write # Upload release assets
    env:
      RELEASE_TAG: ${{ needs.compute-version.outputs.release_tag }}
      DEV_VERSION: ${{ needs.compute-version.outputs.dev_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0 # Required for git describe to find tags
          persist-credentials: false

      - uses: ./.github/actions/setup-mux

      - name: Patch package.json version for latest channel
        shell: bash
        run: |
          # Use a semver pre-release version so electron-updater emits dev.yml,
          # keeping latest-channel updates separate from stable latest.yml.
          node - <<'NODE'
          const fs = require("node:fs");
          const packageJsonPath = "package.json";
          const pkg = JSON.parse(fs.readFileSync(packageJsonPath, "utf8"));
          pkg.version = process.env.DEV_VERSION;
          fs.writeFileSync(packageJsonPath, `${JSON.stringify(pkg, null, 2)}\n`);
          console.log(`Set package.json version to ${pkg.version}`);
          NODE

      - name: Build application
        run: bun run build

      - name: Setup code signing
        run: ./scripts/setup-macos-signing.sh
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          AC_APIKEY_P8_BASE64: ${{ secrets.AC_APIKEY_P8_BASE64 }}
          AC_APIKEY_ID: ${{ secrets.AC_APIKEY_ID }}
          AC_APIKEY_ISSUER_ID: ${{ secrets.AC_APIKEY_ISSUER_ID }}

      - name: Package and publish for macOS
        run: make dist-mac-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build and Release Linux
    needs: compute-version
    runs-on: ${{ github.repository_owner == 'coder' && 'depot-ubuntu-22.04-16' || 'ubuntu-latest' }}
    permissions:
      contents: write # Upload release assets
    env:
      RELEASE_TAG: ${{ needs.compute-version.outputs.release_tag }}
      DEV_VERSION: ${{ needs.compute-version.outputs.dev_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0 # Required for git describe to find tags
          persist-credentials: false

      - uses: ./.github/actions/setup-mux

      - name: Patch package.json version for latest channel
        shell: bash
        run: |
          # Use a semver pre-release version so electron-updater emits dev.yml,
          # keeping latest-channel updates separate from stable latest.yml.
          node - <<'NODE'
          const fs = require("node:fs");
          const packageJsonPath = "package.json";
          const pkg = JSON.parse(fs.readFileSync(packageJsonPath, "utf8"));
          pkg.version = process.env.DEV_VERSION;
          fs.writeFileSync(packageJsonPath, `${JSON.stringify(pkg, null, 2)}\n`);
          console.log(`Set package.json version to ${pkg.version}`);
          NODE

      - name: Build application
        run: bun run build

      - name: Package and publish for Linux
        run: bun x electron-builder --linux --publish always
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build and Release Windows
    needs: compute-version
    runs-on: windows-latest
    permissions:
      contents: write # Upload release assets
      id-token: write # GCP workload identity for code signing
    env:
      RELEASE_TAG: ${{ needs.compute-version.outputs.release_tag }}
      DEV_VERSION: ${{ needs.compute-version.outputs.dev_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0
          persist-credentials: false

      - uses: ./.github/actions/setup-mux

      - name: Add MSYS2 make to PATH
        shell: pwsh
        run: |
          # MSYS2 is pre-installed on Windows runners, just needs to be in PATH
          # Install make via pacman (faster than choco)
          C:\msys64\usr\bin\pacman.exe -S --noconfirm make
          echo "C:\msys64\usr\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify tools
        shell: bash
        run: |
          make --version
          bun --version
          magick --version | head -1

      - name: Patch package.json version for latest channel
        shell: bash
        run: |
          # Use a semver pre-release version so electron-updater emits dev.yml,
          # keeping latest-channel updates separate from stable latest.yml.
          node - <<'NODE'
          const fs = require("node:fs");
          const packageJsonPath = "package.json";
          const pkg = JSON.parse(fs.readFileSync(packageJsonPath, "utf8"));
          pkg.version = process.env.DEV_VERSION;
          fs.writeFileSync(packageJsonPath, `${JSON.stringify(pkg, null, 2)}\n`);
          console.log(`Set package.json version to ${pkg.version}`);
          NODE

      - name: Build application
        run: bun run build

      - name: Setup code signing
        id: signing
        uses: ./.github/actions/setup-windows-signing
        with:
          ev_signing_cert: ${{ secrets.EV_SIGNING_CERT }}
          gcp_workload_id_provider: ${{ vars.GCP_WORKLOAD_ID_PROVIDER }}
          gcp_service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Package and publish for Windows (.exe)
        run: bun x electron-builder --win --publish always
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # EV signing environment variables (used by custom sign script if configured)
          EV_KEYSTORE: ${{ vars.EV_KEYSTORE }}
          EV_KEY: ${{ vars.EV_KEY }}
          EV_TSA_URL: ${{ vars.EV_TSA_URL }}
          GCLOUD_ACCESS_TOKEN: ${{ steps.signing.outputs.gcloud_access_token }}

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: windows-release
          path: |
            release/*.exe
            release/*.exe.blockmap
          if-no-files-found: error

  cleanup:
    name: Cleanup old latest pre-releases
    runs-on: ubuntu-latest
    needs: [compute-version, build-macos, build-linux, build-windows]
    if: always()
    permissions:
      contents: write # Delete old pre-releases
    steps:
      - name: Delete old v*-dev.* pre-releases beyond latest 20
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          mapfile -t OLD_TAGS < <(
            gh api --paginate "repos/${GITHUB_REPOSITORY}/releases?per_page=100" --jq '
              .[]
              | select(.prerelease)
              | select(.tag_name | test("^v[0-9]+\\.[0-9]+\\.[0-9]+-dev\\.[0-9]+$"))
              | [.created_at, .tag_name]
              | @tsv
            ' \
              | sort -r \
              | awk 'NR > 20 { print $2 }'
          )

          if [ "${#OLD_TAGS[@]}" -eq 0 ]; then
            echo "No old latest pre-releases to delete."
            exit 0
          fi

          for tag in "${OLD_TAGS[@]}"; do
            echo "Deleting old pre-release $tag"
            gh release delete "$tag" --yes --cleanup-tag
          done
