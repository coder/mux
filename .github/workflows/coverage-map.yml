name: Coverage Map Generation

on:
  # Run daily at 2 AM UTC
  schedule:
    - cron: "0 2 * * *"
  # Allow manual trigger
  workflow_dispatch:
  # Also regenerate when the selective test system changes
  push:
    branches: [main]
    paths:
      - "scripts/selective-tests/**"
      - "tests/integration/**"
      - ".github/workflows/coverage-map.yml"

concurrency:
  group: coverage-map-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate-coverage-map:
    name: Generate Coverage Map
    runs-on: ${{ github.repository_owner == 'coder' && 'depot-ubuntu-22.04-16' || 'ubuntu-latest' }}
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-mux

      - name: Build worker files
        run: make build-main

      - name: Generate coverage map
        run: bun scripts/selective-tests/generate-coverage-map.ts --output coverage-map.json
        env:
          TEST_INTEGRATION: "1"
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Upload coverage map artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-map
          path: coverage-map.json
          retention-days: 30

      - name: Cache coverage map for CI
        uses: actions/cache/save@v4
        with:
          path: coverage-map.json
          key: coverage-map-${{ github.sha }}

      # Also save with a "latest" key that PRs can restore from
      - name: Cache coverage map (latest)
        uses: actions/cache/save@v4
        with:
          path: coverage-map.json
          key: coverage-map-latest-${{ github.run_id }}
          # This creates a new cache entry each run, but restore-keys in CI
          # will match the most recent one

      - name: Summary
        run: |
          echo "## Coverage Map Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Generated at:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Map Statistics" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          jq '{
            version,
            generatedAt,
            commitSha,
            testCount: (.allTests | length),
            filesWithCoverage: ([.fileToTests | to_entries[] | select(.value | length > 0)] | length),
            totalMappings: ([.fileToTests | to_entries[] | .value | length] | add)
          }' coverage-map.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
